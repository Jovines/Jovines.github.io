{"title":"JVM-内存管理和垃圾回收","date":"2020-04-01T13:38:41.000Z","link":"2020/04/01/JVM-内存管理和垃圾回收","comments":true,"tags":["干货"],"categories":["Java"],"updated":"2020-04-02T17:23:54.915Z","content":"<h2 id=\"内存管理\">内存管理<a href=\"2020/04/01/JVM-内存管理和垃圾回收#内存管理\"></a></h2><p><img src=\"/2020/04/01/JVM-内存管理和垃圾回收/../../../../Users/12466/Downloads/JVM%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E5%9B%BE%20(1).png\" alt=\"JVM 内存管理总图 (JVM-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%80%BB%E5%9B%BE%20(1)-1585846004384.png)\" class=\"article-img\"></p>\n<h3 id=\"方法区-（元空间-持久代）\">方法区 （元空间/持久代）<a href=\"2020/04/01/JVM-内存管理和垃圾回收#方法区-（元空间-持久代）\"></a></h3><p><strong>线程共享</strong>，存放类加载之后存放类的数据结构，静态常量，JIT(即时编译器)编译后代码也在方法区存放</p>\n<h3 id=\"堆区\">堆区<a href=\"2020/04/01/JVM-内存管理和垃圾回收#堆区\"></a></h3><p><strong>线程共享</strong>，对象所在的区域，也是垃圾回收的主要场所</p>\n<h3 id=\"虚拟机栈\">虚拟机栈<a href=\"2020/04/01/JVM-内存管理和垃圾回收#虚拟机栈\"></a></h3><p>按照方法执行的顺序，先进后出</p>\n<h4 id=\"栈帧\">栈帧<a href=\"2020/04/01/JVM-内存管理和垃圾回收#栈帧\"></a></h4><ul>\n<li>局部变量表</li>\n<li>操作数栈</li>\n<li>动态链接</li>\n<li>方法出口</li>\n</ul>\n<p>来看看一段简单的代码，主要分析demo()方法</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Main</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span></span>&#123;</span><br><span class=\"line\">        demo();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span>  <span class=\"title\">demo</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> a = <span class=\"number\">20</span>;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> b = <span class=\"number\">30</span>;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> c = (a + b) * <span class=\"number\">100</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>这里的demo（）方法会有一个局部变量表</p>\n<p><img src=\"/2020/04/01/JVM-内存管理和垃圾回收/../../../../Users/12466/Downloads/%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8%20(1).png\" alt=\"局部变量表 (JVM-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%92%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8%20(1).png)\" class=\"article-img\"></p>\n<p>赋默认值，真正使用的时候才会对其进行初始化。</p>\n<p>我们把编译好了的java文件利用javap命令对class文件进行反汇编 javap -c Main.class</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Compiled from <span class=\"string\">\"Main.java\"</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Main</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Main</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       <span class=\"number\">0</span>: aload_0</span><br><span class=\"line\">       1: invokespecial #1                  // Method java/lang/Object.\"&lt;init&gt;\":()V</span><br><span class=\"line\">       <span class=\"number\">4</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(java.lang.String[])</span></span>;</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       0: invokestatic  #2                  // Method demo:()I</span><br><span class=\"line\">       <span class=\"number\">3</span>: pop</span><br><span class=\"line\">       <span class=\"number\">4</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">demo</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       <span class=\"number\">0</span>: bipush        <span class=\"number\">20</span>  <span class=\"comment\">//将一个8位带符号整数（20）压入栈</span></span><br><span class=\"line\">       <span class=\"number\">2</span>: istore_0\t\t\t<span class=\"comment\">//将操作数栈中栈顶int类型的值存入局部变量0</span></span><br><span class=\"line\">       <span class=\"number\">3</span>: bipush        <span class=\"number\">30</span>\t<span class=\"comment\">//将一个8位带符号整数（30）压入栈</span></span><br><span class=\"line\">       <span class=\"number\">5</span>: istore_1\t\t\t<span class=\"comment\">//将操作数栈中栈顶int类型的值存入局部变量1</span></span><br><span class=\"line\">       <span class=\"number\">6</span>: iload_0\t\t\t<span class=\"comment\">//将局部变量0中的int类型值装载到操作数栈</span></span><br><span class=\"line\">       <span class=\"number\">7</span>: iload_1\t\t\t<span class=\"comment\">//将局部变量1中的int类型值装载到操作数栈</span></span><br><span class=\"line\">       <span class=\"number\">8</span>: iadd\t\t\t\t<span class=\"comment\">//操作数栈中的前两个int弹出并相加，并将结果压入操作数栈顶</span></span><br><span class=\"line\">       <span class=\"number\">9</span>: bipush        <span class=\"number\">100</span>\t<span class=\"comment\">//将一个8位带符号整数（100）压入栈</span></span><br><span class=\"line\">      <span class=\"number\">11</span>: imul\t\t\t\t<span class=\"comment\">//操作数栈中的前两个int弹出并相乘，并将结果压入操作数栈顶</span></span><br><span class=\"line\">      <span class=\"number\">12</span>: istore_2\t\t\t<span class=\"comment\">//将操作数栈中栈顶int类型的值存入局部变量2</span></span><br><span class=\"line\">      <span class=\"number\">13</span>: iload_2\t\t\t<span class=\"comment\">//将局部变量2中的int类型值装载到操作数栈</span></span><br><span class=\"line\">      <span class=\"number\">14</span>: ireturn\t\t\t<span class=\"comment\">//将操作数栈中的int值返回</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n\n<p>从注释可以很清晰的看出来</p>\n<h3 id=\"程序计数器\">程序计数器<a href=\"2020/04/01/JVM-内存管理和垃圾回收#程序计数器\"></a></h3><p>当前线程执行的字节码的位置指示器</p>\n<h3 id=\"本地方法栈\">本地方法栈<a href=\"2020/04/01/JVM-内存管理和垃圾回收#本地方法栈\"></a></h3><p>为JVM提供使用native方法的服务大致结构和虚拟机栈差不多 </p>\n<h2 id=\"垃圾回收\">垃圾回收<a href=\"2020/04/01/JVM-内存管理和垃圾回收#垃圾回收\"></a></h2><p>STW（stop the world）：停止其他所有工作</p>\n<p>Minor GC：轻量级，耗时短，会出现STW</p>\n<p>Full GC：重量级，耗时长，会出现STW</p>\n<h3 id=\"分代垃圾回收\">分代垃圾回收<a href=\"2020/04/01/JVM-内存管理和垃圾回收#分代垃圾回收\"></a></h3><h4 id=\"新生代\">新生代<a href=\"2020/04/01/JVM-内存管理和垃圾回收#新生代\"></a></h4><p>对象会被优先被分配到这个地方</p>\n<h4 id=\"老年代\">老年代<a href=\"2020/04/01/JVM-内存管理和垃圾回收#老年代\"></a></h4><p>当对象满足一定条件之后会被放到老年代</p>\n<p><strong>注意</strong>：java8之后老年代在Full GC之前是会执行一次Minor GC的，如果内存依然不足，才会执行Full GC</p>\n<h3 id=\"算法\">算法<a href=\"2020/04/01/JVM-内存管理和垃圾回收#算法\"></a></h3><ul>\n<li><p>标记清除</p>\n<p>优点：快</p>\n<p>缺点：会出现内存碎片，导致大对象进来会直接进入老年代</p>\n</li>\n<li><p>标记整理</p>\n<p>解决上面的的内存碎片问题</p>\n</li>\n<li><p>复制</p>\n<p>From（S0）区和To（S1）区来实现这个算法。</p>\n<blockquote>\n<p>这也是为什么需要交换的原因，To（S1）区永远保持空白</p>\n</blockquote>\n</li>\n</ul>\n","prev":{"title":"JVM 操作指令记录一览","link":"2020/04/03/JVM-操作指令记录一览"},"next":{"title":"类加载和类加载器","link":"2020/04/01/类加载和类加载器"},"plink":"https://treeeeeeee.github.io/2020/04/01/JVM-内存管理和垃圾回收/","toc":[{"title":"内存管理","id":"内存管理","index":"1","children":[{"title":"方法区 （元空间/持久代）","id":"方法区-（元空间-持久代）","index":"1.1"},{"title":"堆区","id":"堆区","index":"1.2"},{"title":"虚拟机栈","id":"虚拟机栈","index":"1.3","children":[{"title":"栈帧","id":"栈帧","index":"1.3.1"}]},{"title":"程序计数器","id":"程序计数器","index":"1.4"},{"title":"本地方法栈","id":"本地方法栈","index":"1.5"}]},{"title":"垃圾回收","id":"垃圾回收","index":"2","children":[{"title":"分代垃圾回收","id":"分代垃圾回收","index":"2.1","children":[{"title":"新生代","id":"新生代","index":"2.1.1"},{"title":"老年代","id":"老年代","index":"2.1.2"}]},{"title":"算法","id":"算法","index":"2.2"}]}]}