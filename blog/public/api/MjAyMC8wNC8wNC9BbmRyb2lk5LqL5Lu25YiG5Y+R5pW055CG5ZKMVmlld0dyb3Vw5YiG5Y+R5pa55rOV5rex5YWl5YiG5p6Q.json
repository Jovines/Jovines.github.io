{"title":"Android事件分发整理和ViewGroup分发方法深入分析","date":"2020-04-04T04:04:19.000Z","date_formatted":{"ll":"2020年4月4日","L":"2020/04/04","MM-DD":"04-04"},"link":"2020/04/04/Android事件分发整理和ViewGroup分发方法深入分析","comments":true,"tags":["干货"],"categories":["Android"],"updated":"2020-04-04T08:28:33.963Z","content":"<h1 id=\"事件传递流程\">事件传递流程<a href=\"#事件传递流程\" title=\"事件传递流程\"></a></h1><h4 id=\"事件向下依次传递顺序\">事件向下依次传递顺序<a href=\"#事件向下依次传递顺序\" title=\"事件向下依次传递顺序\"></a></h4><ol><li><code>Activity</code></li><li><code>PhoneWindow</code></li><li><code>ViewGroup</code></li><li><code>View</code></li></ol><h4 id=\"主要方法\">主要方法<a href=\"#主要方法\" title=\"主要方法\"></a></h4><ul><li><p><code>dispatchTouchEvent</code></p><ul><li>返回true表示下层消耗了事件</li><li>返回false表示下层消耗了事件</li></ul></li><li><p><code>onInterceptTouchEvent</code>（View没有这个方法）</p><ul><li><p>返回true表示拦截事件</p></li><li><p>返回false表示放行事件</p></li><li><p>如果当前<code>ViewGroup</code>拦截了一个事件序列中的任意一个事件后，那么在同一个事件序列当中，此方法不会被再次调用，并且，后续事件不会传递下去，返回结果表示是否拦截当前事件。</p></li></ul></li><li><p><code>onTouchEvent</code></p><ul><li><p>点击事件处理的主要方法</p></li><li><p>由于View没有拦截方法，所以一旦分发到它会直接调用此方法，View会默认消耗掉事件</p></li></ul></li></ul><h1 id=\"viewgroup主要tag说明\"><code>ViewGroup</code>主要Tag说明<a href=\"#viewgroup主要tag说明\" title=\"ViewGroup主要Tag说明\"></a></h1><h3 id=\"mfirsttouchtarget\"><code>mFirstTouchTarget</code><a href=\"#mfirsttouchtarget\" title=\"mFirstTouchTarget\"></a></h3><ol><li><code>mFirstTouchTarget</code> 为null, 那么<code>ViewGroup</code> 就默认拦截接下来同一序列中所有的点击事件</li><li><code>mFirstTouchTarget</code> 不为null, 就说明找到子<strong>View</strong>来处理这个事件，并且不会再询问<code>onInterceptTouchEvent</code>是否要拦截事件，将后续事件交于这个<strong>View</strong>去处理</li></ol><p><strong>源码证明<code>android.view.ViewGroup#dispatchTouchEvent</code></strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class=\"line\">        || mFirstTouchTarget != <span class=\"keyword\">null</span>) &#123;<span class=\"comment\">//观点二中的不会再调用onInterceptTouchEvent的证据</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!disallowIntercept) &#123;</span><br><span class=\"line\">        intercepted = onInterceptTouchEvent(ev);</span><br><span class=\"line\">        ev.setAction(action); <span class=\"comment\">// restore action in case it was changed</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        intercepted = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">//观点一证据</span></span><br><span class=\"line\">    <span class=\"comment\">//当一个事件不是ACTION_DOWN而且mFirstTouchTarget为空</span></span><br><span class=\"line\">    <span class=\"comment\">//说明找不到一个子View来处理这个事件，那就默认拦截</span></span><br><span class=\"line\">    <span class=\"comment\">// There are no touch targets and this action is not an initial down</span></span><br><span class=\"line\">    <span class=\"comment\">// so this view group continues to intercept touches.</span></span><br><span class=\"line\">    intercepted = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h4 id=\"哪些情况mfirsttouchtarget会为空？\">哪些情况<code>mFirstTouchTarget</code>会为空？<a href=\"#哪些情况mfirsttouchtarget会为空？\" title=\"哪些情况mFirstTouchTarget会为空？\"></a></h4><ul><li><code>ViewGroup</code> 没有子元素</li><li>子元素处理了点击点击事件，但是在<code>dispatchTouchEvent</code> 中返回了false, 这一般是因为子元素在<code>onTouchEvent</code> 中返回了false</li></ul><h3 id=\"flag_disallow_intercept\">FLAG_DISALLOW_INTERCEPT<a href=\"#flag_disallow_intercept\" title=\"FLAG_DISALLOW_INTERCEPT\"></a></h3><p>该tag会对<code>ViewGroup</code>的拦截逻辑进行影响</p>\n<p>调用<code>requestDisallowInterceptTouchEvent</code>方法之后，会改变该tag的值</p>\n<h1 id=\"整个viewgroup的dispatchtouchevent详细分析\">整个<code>ViewGroup的dispatchTouchEvent</code>详细分析<a href=\"#整个viewgroup的dispatchtouchevent详细分析\" title=\"整个ViewGroup的dispatchTouchEvent详细分析\"></a></h1><p>这是最复杂的部分也是解决滑动冲突的关键部分，代码很长，一步步看，</p>\n<p>其中以$$$开头的注释与事件分发无关</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">dispatchTouchEvent</span><span class=\"params\">(MotionEvent ev)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mInputEventConsistencyVerifier != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        mInputEventConsistencyVerifier.onTouchEvent(ev, <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class=\"line\">        ev.setTargetAccessibilityFocus(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">boolean</span> handled = <span class=\"keyword\">false</span>;<span class=\"comment\">//这个变量就是要返回的boolean类型的值</span></span><br><span class=\"line\">    <span class=\"comment\">//$$$对点击事件进行过滤，这里是方便应用对应的安全策略</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> action = ev.getAction();<span class=\"comment\">//获取当前点击事件</span></span><br><span class=\"line\">        <span class=\"comment\">//$$$对当前点击事件进行 与 操作，这里是对多点触控的处理ACTION_MASK是0xff</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</span><br><span class=\"line\">        <span class=\"comment\">//判断当前点击事件是不是Down，是的话就会重置一些状态，开启新的一轮点击事件</span></span><br><span class=\"line\">        <span class=\"comment\">//其中包括将FLAG_DISALLOW_INTERCEPT和mFirstTouchTarget重置</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class=\"line\">            cancelAndClearTouchTargets(ev);</span><br><span class=\"line\">            resetTouchState();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//这个变量会根据onInterceptTouchEvent的调用状态或者返回值确定</span></span><br><span class=\"line\">        <span class=\"comment\">//也就是 是否拦截</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> intercepted;</span><br><span class=\"line\">        <span class=\"comment\">//如果当前事件是Down，说明开启了新的一轮的事件序列，那么进入条件判断</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class=\"line\">            <span class=\"comment\">//如果不是Down，那么如果mFirstTouchTarget不为空的话也满足要求</span></span><br><span class=\"line\">                || mFirstTouchTarget != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//查看子元素是否要求父元素不要拦截事件，也就是在子元素中调用了父元素的</span></span><br><span class=\"line\">            <span class=\"comment\">//requestDisallowInterceptTouchEvent方法之后，会在这里根据结果生效</span></span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"comment\">//如果子元素要求父元素不要拦截</span></span><br><span class=\"line\">            <span class=\"comment\">//那么父元素就不会执行onInterceptTouchEvent询问自己是否要拦截</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!disallowIntercept) &#123;</span><br><span class=\"line\">                <span class=\"comment\">//如果子元素没有要求父元素不要拦截，这里则会调用</span></span><br><span class=\"line\">                intercepted = onInterceptTouchEvent(ev);</span><br><span class=\"line\">                <span class=\"comment\">//$$$恢复操作，以防它被更改</span></span><br><span class=\"line\">                ev.setAction(action); </span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">//被要求不拦截，默认赋值false，表示不拦截</span></span><br><span class=\"line\">                intercepted = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//没有找到子元素处理（即mFirstTouchTarget == null），也并非是Down事件，则默认拦截</span></span><br><span class=\"line\">            intercepted = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//如果被拦截，启动正常的事件分发。</span></span><br><span class=\"line\">        <span class=\"comment\">//或者如果已经有一个处理手势的视图，则执行正常的事件分发。</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (intercepted || mFirstTouchTarget != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            ev.setTargetAccessibilityFocus(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> canceled = resetCancelNextUpFlag(<span class=\"keyword\">this</span>)</span><br><span class=\"line\">                || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class=\"number\">0</span>;</span><br><span class=\"line\">        </span><br><span class=\"line\">       <span class=\"comment\">//新建一个TouchTarget</span></span><br><span class=\"line\">        TouchTarget newTouchTarget = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">//有没有获取到最新的TouchTarget，这里也是一个标志</span></span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> alreadyDispatchedToNewTouchTarget = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"comment\">//没有取消，并且没有被拦截的话就找子元素处理</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus()</span><br><span class=\"line\">                    ? findChildWithAccessibilityFocus() : <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class=\"line\">                    || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class=\"line\">                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> actionIndex = ev.getActionIndex(); <span class=\"comment\">// always 0 for down</span></span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> idBitsToAssign = split ? <span class=\"number\">1</span> &lt;&lt; ev.getPointerId(actionIndex)</span><br><span class=\"line\">                        : TouchTarget.ALL_POINTER_IDS;</span><br><span class=\"line\"></span><br><span class=\"line\">                removePointersFromTouchTargets(idBitsToAssign);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> childrenCount = mChildrenCount;</span><br><span class=\"line\">                <span class=\"comment\">//如果当前ViewGroup有子控件，则开始寻找</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (newTouchTarget == <span class=\"keyword\">null</span> &amp;&amp; childrenCount != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//获取位置</span></span><br><span class=\"line\">                    <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> x = ev.getX(actionIndex);</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> y = ev.getY(actionIndex);</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> customOrder = preorderedList == <span class=\"keyword\">null</span></span><br><span class=\"line\">                            &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> View[] children = mChildren;</span><br><span class=\"line\">                    <span class=\"comment\">//倒叙开始寻找</span></span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = childrenCount - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> childIndex = getAndVerifyPreorderedIndex(</span><br><span class=\"line\">                                childrenCount, i, customOrder);</span><br><span class=\"line\">                        <span class=\"keyword\">final</span> View child = getAndVerifyPreorderedView(</span><br><span class=\"line\">                                preorderedList, children, childIndex);</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (childWithAccessibilityFocus != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (childWithAccessibilityFocus != child) &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            childWithAccessibilityFocus = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                            i = childrenCount - <span class=\"number\">1</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"comment\">//这里判断当前遍历到的这个子元素能不能接收点击事件，</span></span><br><span class=\"line\">                        <span class=\"comment\">//如果不能进行下一次</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (!child.canReceivePointerEvents()</span><br><span class=\"line\">                                || !isTransformedTouchPointInView(x, y, child, <span class=\"keyword\">null</span>)) &#123;</span><br><span class=\"line\">                            ev.setTargetAccessibilityFocus(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">                            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"comment\">//从mFirstTouchTarget序列中（其实这里是一个单链表）</span></span><br><span class=\"line\">                        <span class=\"comment\">//找与这个child对应的TouchTarget,没有</span></span><br><span class=\"line\">                        newTouchTarget = getTouchTarget(child);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (newTouchTarget != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">//如果能够找到对应的，说明该view已经处理过当前点击事件序列前面一点的事件</span></span><br><span class=\"line\">                            <span class=\"comment\">//已经在其范围内接受触摸,除开它正在处理的再给它新的位置指针</span></span><br><span class=\"line\">                            newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class=\"line\">                            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        resetCancelNextUpFlag(child);</span><br><span class=\"line\">                        <span class=\"comment\">//如果能够运行到这里说明该子元素满足要求，可以接收点击事件</span></span><br><span class=\"line\">                        <span class=\"comment\">//dispatchTransformedTouchEvent中会执行子元素的dispatchTouchEvent</span></span><br><span class=\"line\">                        <span class=\"comment\">//如果该子元素将事件消耗，则进入判断语句</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (dispatchTransformedTouchEvent(ev, <span class=\"keyword\">false</span>, child, </span><br><span class=\"line\">                                                          idBitsToAssign)) &#123;</span><br><span class=\"line\">                            mLastTouchDownTime = ev.getDownTime();</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (preorderedList != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                                <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">if</span> (children[childIndex] == mChildren[j]) &#123;</span><br><span class=\"line\">                                        mLastTouchDownIndex = j;</span><br><span class=\"line\">                                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                                mLastTouchDownIndex = childIndex;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            mLastTouchDownX = ev.getX();</span><br><span class=\"line\">                            mLastTouchDownY = ev.getY();</span><br><span class=\"line\">                            <span class=\"comment\">//如果这个事件消耗了，则生成一个对应的TouchTarget</span></span><br><span class=\"line\">                            <span class=\"comment\">//并赋值给newTouchTarget</span></span><br><span class=\"line\">                            <span class=\"comment\">//并且在addTouchTarget方法里也将这个赋值给了mFirstTouchTarget</span></span><br><span class=\"line\">                            newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class=\"line\">                            alreadyDispatchedToNewTouchTarget = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                            <span class=\"comment\">//停止在子元素中寻找子元素去处理</span></span><br><span class=\"line\">                            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        ev.setTargetAccessibilityFocus(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (preorderedList != <span class=\"keyword\">null</span>) preorderedList.clear();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (newTouchTarget == <span class=\"keyword\">null</span> &amp;&amp; mFirstTouchTarget != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    newTouchTarget = mFirstTouchTarget;</span><br><span class=\"line\">                    <span class=\"keyword\">while</span> (newTouchTarget.next != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        newTouchTarget = newTouchTarget.next;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//mFirstTouchTarget == null如果这里为空说明没有找到子元素能够处理或者消耗了</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mFirstTouchTarget == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//直接传null进去，那么这个方法内部就会直接调用该ViewGroup的</span></span><br><span class=\"line\">            <span class=\"comment\">//super.dispatchTouchEvent(event)</span></span><br><span class=\"line\">            handled = dispatchTransformedTouchEvent(ev, canceled, <span class=\"keyword\">null</span>,</span><br><span class=\"line\">                    TouchTarget.ALL_POINTER_IDS);</span><br><span class=\"line\">            <span class=\"comment\">//----------------------------------------------------------</span></span><br><span class=\"line\">            <span class=\"comment\">//后面代码对事件分发流程理解应该影响不大，就不看了</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            TouchTarget predecessor = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            TouchTarget target = mFirstTouchTarget;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (target != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">final</span> TouchTarget next = target.next;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</span><br><span class=\"line\">                    handled = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</span><br><span class=\"line\">                            || intercepted;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class=\"line\">                            target.child, target.pointerIdBits)) &#123;</span><br><span class=\"line\">                        handled = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (cancelChild) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (predecessor == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            mFirstTouchTarget = next;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            predecessor.next = next;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        target.recycle();</span><br><span class=\"line\">                        target = next;</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                predecessor = target;</span><br><span class=\"line\">                target = next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (canceled</span><br><span class=\"line\">                || actionMasked == MotionEvent.ACTION_UP</span><br><span class=\"line\">                || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class=\"line\">            resetTouchState();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> actionIndex = ev.getActionIndex();</span><br><span class=\"line\">            <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> idBitsToRemove = <span class=\"number\">1</span> &lt;&lt; ev.getPointerId(actionIndex);</span><br><span class=\"line\">            removePointersFromTouchTargets(idBitsToRemove);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> handled;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>呼~~好累，这么一分析啥原理不久都来了，什么解决滑动冲突的方法还不是信手拈来，什么外部拦截或者内部拦截的原理不久一下子清晰了。累了，去泡杯茶再来。</p>\n","next":{"title":"JVM 操作指令记录一览","link":"2020/04/03/JVM-操作指令记录一览"},"plink":"https://jonvines.github.io/2020/04/04/Android事件分发整理和ViewGroup分发方法深入分析/","toc":[{"id":"事件传递流程","title":"事件传递流程","index":"1","children":[{"id":"事件向下依次传递顺序","title":"事件向下依次传递顺序","index":"1.1"},{"id":"主要方法","title":"主要方法","index":"1.2"}]}]}